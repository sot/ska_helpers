<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ska_helpers.utils &#8212; Ska Helpers 0.16.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-astropy.css?v=f4f7060c" />
    
    <script src="../../_static/documentation_options.js?v=7de89ed4"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska! </span><span id="logotext2">ska_helpers</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://sot.github.io/">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">Ska Helpers 0.16.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" >Module code</a> &#187;</li>
      <li><a href="../ska_helpers.html" accesskey="U">ska_helpers</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ska_helpers.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;LazyDict&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LazyVal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LRUDict&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lru_cache_timed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;temp_env_var&quot;</span><span class="p">,</span>
    <span class="s2">&quot;convert_to_int_float_str&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TypedDescriptor&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">get_owner</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the owner of a file or directory.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    path : str or pathlib.Path</span>
<span class="sd">        The path to the file or directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    str</span>
<span class="sd">        The name of the owner of the file or directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

    <span class="kn">from</span> <span class="nn">testr</span> <span class="kn">import</span> <span class="n">test_helper</span>

    <span class="k">if</span> <span class="n">test_helper</span><span class="o">.</span><span class="n">is_windows</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">win32security</span>

        <span class="c1"># Suggested by copilot chat, seems to</span>
        <span class="n">security_descriptor</span> <span class="o">=</span> <span class="n">win32security</span><span class="o">.</span><span class="n">GetFileSecurity</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">win32security</span><span class="o">.</span><span class="n">OWNER_SECURITY_INFORMATION</span>
        <span class="p">)</span>
        <span class="n">owner_sid</span> <span class="o">=</span> <span class="n">security_descriptor</span><span class="o">.</span><span class="n">GetSecurityDescriptorOwner</span><span class="p">()</span>
        <span class="n">owner_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">win32security</span><span class="o">.</span><span class="n">LookupAccountSid</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">owner_sid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">owner_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">owner</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">owner_name</span>


<span class="k">def</span> <span class="nf">_lazy_load_wrap</span><span class="p">(</span><span class="n">unbound_method</span><span class="p">):</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">unbound_method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">unbound_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<div class="viewcode-block" id="LazyVal">
<a class="viewcode-back" href="../../index.html#ska_helpers.utils.LazyVal">[docs]</a>
<span class="k">class</span> <span class="nc">LazyVal</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Value which is lazy-initialized using supplied function ``load_func``.</span>

<span class="sd">    This class allows defining a module-level value that is expensive to</span>
<span class="sd">    initialize, where the initialization is done lazily (only when actually</span>
<span class="sd">    needed).</span>

<span class="sd">    The lazy value is accessed using the ``val`` property.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ::</span>

<span class="sd">      from ska_helpers.utils import LazyVal</span>

<span class="sd">      def load_func(a):</span>
<span class="sd">          # Some expensive function in practice</span>
<span class="sd">          print(&#39;Here in load_func&#39;)</span>
<span class="sd">          return a</span>

<span class="sd">      ONE = LazyVal(load_func, 1)</span>

<span class="sd">      print(&#39;ONE is defined but not yet loaded&#39;)</span>
<span class="sd">      print(ONE.val)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    load_func : function</span>
<span class="sd">        Reference to a function that returns a dict to init this dict object</span>
<span class="sd">    *args</span>
<span class="sd">        Arguments list for ``load_func``</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Keyword arguments for ``load_func``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_func</span> <span class="o">=</span> <span class="n">load_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_val&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>

            <span class="c1"># Delete these so serialization always works (pickling a func can fail)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_func</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span></div>



<div class="viewcode-block" id="LazyDict">
<a class="viewcode-back" href="../../index.html#ska_helpers.utils.LazyDict">[docs]</a>
<span class="k">class</span> <span class="nc">LazyDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dict which is lazy-initialized using supplied function ``load_func``.</span>

<span class="sd">    This class allows defining a module-level dict that is expensive to</span>
<span class="sd">    initialize, where the initialization is done lazily (only when actually</span>
<span class="sd">    needed).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ::</span>

<span class="sd">      from ska_helpers.utils import LazyDict</span>

<span class="sd">      def load_func(a, b):</span>
<span class="sd">          # Some expensive function in practice</span>
<span class="sd">          print(&#39;Here in load_func&#39;)</span>
<span class="sd">          return {&#39;a&#39;: a, &#39;b&#39;: b}</span>

<span class="sd">      ONE = LazyDict(load_func, 1, 2)</span>

<span class="sd">      print(&#39;ONE is defined but not yet loaded&#39;)</span>
<span class="sd">      print(ONE[&#39;a&#39;])</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    load_func : function</span>
<span class="sd">        Reference to a function that returns a dict to init this dict object</span>
<span class="sd">    *args</span>
<span class="sd">        Arguments list for ``load_func``</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Keyword arguments for ``load_func``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_func</span> <span class="o">=</span> <span class="n">load_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_func</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Delete these so serialization always works (pickling a func can fail)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_func</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="fm">__contains__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">)</span>
    <span class="fm">__eq__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">)</span>
    <span class="fm">__ge__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__ge__</span><span class="p">)</span>
    <span class="fm">__gt__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__gt__</span><span class="p">)</span>
    <span class="fm">__iter__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">)</span>
    <span class="fm">__le__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__le__</span><span class="p">)</span>
    <span class="fm">__len__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__len__</span><span class="p">)</span>
    <span class="fm">__lt__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__lt__</span><span class="p">)</span>
    <span class="fm">__ne__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">)</span>
    <span class="fm">__repr__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">)</span>
    <span class="fm">__reversed__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__reversed__</span><span class="p">)</span>
    <span class="n">__sizeof__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">__sizeof__</span><span class="p">)</span>
    <span class="fm">__str__</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="fm">__str__</span><span class="p">)</span>
    <span class="n">copy</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>
    <span class="n">get</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">pop</span><span class="p">)</span>
    <span class="n">popitem</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">popitem</span><span class="p">)</span>
    <span class="n">setdefault</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">_lazy_load_wrap</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div>



<div class="viewcode-block" id="lru_cache_timed">
<a class="viewcode-back" href="../../index.html#ska_helpers.utils.lru_cache_timed">[docs]</a>
<span class="k">def</span> <span class="nf">lru_cache_timed</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">typed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LRU cache decorator where the cache expires after ``timeout`` seconds.</span>

<span class="sd">    This wraps the functools.lru_cache decorator so that the entire cache gets</span>
<span class="sd">    cleared if the cache is older than ``timeout`` seconds.</span>

<span class="sd">    This is mostly copied from this gist, with no license specified:</span>
<span class="sd">    https://gist.github.com/helix84/05ee246d6c80bc7bacdfa6a62fbff3fa</span>

<span class="sd">    The cachetools package provides a way to apply the timeout per-item, if that</span>
<span class="sd">    is required.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    maxsize : int</span>
<span class="sd">        functools.lru_cache maxsize parameter</span>
<span class="sd">    typed : bool</span>
<span class="sd">        functools.lru_cache typed parameter</span>
<span class="sd">    timeout : int, float</span>
<span class="sd">        Clear cache after ``timeout`` seconds from last clear</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">time</span>

    <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">next_update</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Force cache reset first time</span>
        <span class="c1"># Apply @lru_cache to f</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">maxsize</span><span class="p">,</span> <span class="n">typed</span><span class="o">=</span><span class="n">typed</span><span class="p">)(</span><span class="n">func</span><span class="p">)</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">clear_cache_if_expired</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">clear_cache_if_expired</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">next_update</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;=</span> <span class="n">next_update</span><span class="p">:</span>
                <span class="n">func</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
                <span class="n">next_update</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timeout</span>

        <span class="k">def</span> <span class="nf">cache_info</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Report cache statistics&quot;&quot;&quot;</span>
            <span class="n">clear_cache_if_expired</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">cache_info</span><span class="p">()</span>

        <span class="n">_wrapped</span><span class="o">.</span><span class="n">cache_info</span> <span class="o">=</span> <span class="n">cache_info</span>
        <span class="n">_wrapped</span><span class="o">.</span><span class="n">cache_clear</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">cache_clear</span>
        <span class="k">return</span> <span class="n">_wrapped</span>

    <span class="k">return</span> <span class="n">_wrapper</span></div>



<div class="viewcode-block" id="LRUDict">
<a class="viewcode-back" href="../../index.html#ska_helpers.utils.LRUDict">[docs]</a>
<span class="k">class</span> <span class="nc">LRUDict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dict that maintains a fixed capacity and evicts least recently used item when full.</span>

<span class="sd">    Inherits from collections.OrderedDict to maintain the order of insertion.</span>

<span class="sd">    Examples:</span>
<span class="sd">    ---------</span>
<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; d = LRUDict(2)</span>
<span class="sd">        &gt;&gt;&gt; d[&quot;a&quot;] = 1</span>
<span class="sd">        &gt;&gt;&gt; d[&quot;b&quot;] = 2</span>
<span class="sd">        &gt;&gt;&gt; d[&quot;c&quot;] = 3</span>
<span class="sd">        &gt;&gt;&gt; list(d.keys())</span>
<span class="sd">        [&#39;b&#39;, &#39;c&#39;]</span>
<span class="sd">        &gt;&gt;&gt; d[&quot;b&quot;]</span>
<span class="sd">        2</span>
<span class="sd">        &gt;&gt;&gt; d[&quot;a&quot;]</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        KeyError: &#39;a&#39;</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    capacity : int, optional</span>
<span class="sd">        The maximum number of items that the dictionary can hold. Defaults to 128.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
            <span class="n">oldest</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">oldest</span><span class="p">]</span></div>



<div class="viewcode-block" id="temp_env_var">
<a class="viewcode-back" href="../../index.html#ska_helpers.utils.temp_env_var">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">temp_env_var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A context manager that temporarily sets an environment variable.</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; os.environ.get(&quot;MY_VARIABLE&quot;)</span>
<span class="sd">        None</span>
<span class="sd">        &gt;&gt;&gt; with temp_env_var(&quot;MY_VARIABLE&quot;, &quot;my_value&quot;):</span>
<span class="sd">        ...     os.environ.get(&quot;MY_VARIABLE&quot;)</span>
<span class="sd">        ...</span>
<span class="sd">        &#39;my_value&#39;</span>
<span class="sd">        &gt;&gt;&gt; os.environ.get(&quot;MY_VARIABLE&quot;)</span>
<span class="sd">        None</span>

<span class="sd">    :param name: str</span>
<span class="sd">        Name of the environment variable to set.</span>
<span class="sd">    :param value: str</span>
<span class="sd">        Value to set the environment variable to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">original_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>



<div class="viewcode-block" id="convert_to_int_float_str">
<a class="viewcode-back" href="../../index.html#ska_helpers.utils.convert_to_int_float_str">[docs]</a>
<span class="k">def</span> <span class="nf">convert_to_int_float_str</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert an input string into an int, float, or string.</span>

<span class="sd">    This tries to convert the input string into an int using the built-in ``int()``</span>
<span class="sd">    function. If that fails then it tries ``float()``, and finally if that fails it</span>
<span class="sd">    returns the original string.</span>

<span class="sd">    This function is often useful when parsing text representations of structured data</span>
<span class="sd">    where the data types are implicit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    val : str</span>
<span class="sd">        The input string to convert</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int, float, or str</span>
<span class="sd">        The input value as an int, float, or string.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    An input string like &quot;01234&quot; is interpreted as a decimal integer and will be</span>
<span class="sd">    returned as the integer 1234. In some contexts a leading 0 indicates an octal number</span>
<span class="sd">    and to avoid confusion in Python a leading 0 is not allowed in a decimal integer</span>
<span class="sd">    literal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ast</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input value must be a string, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Handle an input like &quot;&#39;string&#39;&quot;</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># If this wasn&#39;t a string literal (e.g. &quot;[1]&quot; then raise and return</span>
                    <span class="c1"># the original string.</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="TypedDescriptor">
<a class="viewcode-back" href="../../index.html#ska_helpers.utils.TypedDescriptor">[docs]</a>
<span class="k">class</span> <span class="nc">TypedDescriptor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to create a descriptor for a dataclass attribute that is cast to a type.</span>

<span class="sd">    This is a base class for creating a descriptor that can be used to define an</span>
<span class="sd">    attribute on a dataclass that is cast to a specific type.  The type is specified by</span>
<span class="sd">    setting the ``cls`` class attribute on the descriptor class.</span>

<span class="sd">    Most commonly ``cls`` is a class like ``CxoTime`` or ``Quat``, but it could also be</span>
<span class="sd">    a built-in like ``int`` or ``float`` or any callable function.</span>

<span class="sd">    This descriptor can be used either as a base class with the ``cls`` class attribute</span>
<span class="sd">    set accordingly, or as a descriptor with the ``cls`` keyword argument set.</span>

<span class="sd">    .. warning:: This descriptor class is recommended for use within a</span>
<span class="sd">       `dataclass &lt;https://docs.python.org/3/library/dataclasses.html&gt;`_. In a normal</span>
<span class="sd">        class the default value **must** be set to the correct type since it will not be</span>
<span class="sd">        coerced to the correct type automatically.</span>

<span class="sd">    The default value cannot be ``list``, ``dict``, or ``set`` since these are mutable</span>
<span class="sd">    and are disallowed by the dataclass machinery. In most cases a ``list`` can be</span>
<span class="sd">    replaced by a ``tuple`` and a ``dict`` can be replaced by an ``OrderedDict``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    default : optional</span>
<span class="sd">        Default value for the attribute. If specified and not ``None``, it will be</span>
<span class="sd">        coerced to the correct type via ``cls(default)``.  If not specified, the default</span>
<span class="sd">        for the attribute is ``None``.</span>
<span class="sd">    required : bool, optional</span>
<span class="sd">        If ``True``, the attribute is required to be set explicitly when the object is</span>
<span class="sd">        created. If ``False`` the default value is used if the attribute is not set.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from dataclasses import dataclass</span>
<span class="sd">    &gt;&gt;&gt; from ska_helpers.utils import TypedDescriptor</span>

<span class="sd">    Here we make a dataclass with an attribute that is cast to an int.</span>

<span class="sd">    &gt;&gt;&gt; @dataclass</span>
<span class="sd">    &gt;&gt;&gt; class SomeClass:</span>
<span class="sd">    ...     int_val: int = TypedDescriptor(required=True, cls=int)</span>
<span class="sd">    &gt;&gt;&gt; obj = SomeClass(10.5)</span>
<span class="sd">    &gt;&gt;&gt; obj.int_val</span>
<span class="sd">    10</span>

<span class="sd">    Here we define a ``QuatDescriptor`` class that can be used repeatedly for any</span>
<span class="sd">    quaternion attribute.</span>

<span class="sd">    &gt;&gt;&gt; from Quaternion import Quat</span>
<span class="sd">    &gt;&gt;&gt; class QuatDescriptor(TypedDescriptor):</span>
<span class="sd">    ...     cls = Quat</span>
<span class="sd">    &gt;&gt;&gt; @dataclass</span>
<span class="sd">    ... class MyClass:</span>
<span class="sd">    ...     att1: Quat = QuatDescriptor(required=True)</span>
<span class="sd">    ...     att2: Quat = QuatDescriptor(default=[10, 20, 30])</span>
<span class="sd">    ...     att3: Quat | None = QuatDescriptor()</span>
<span class="sd">    ...</span>
<span class="sd">    &gt;&gt;&gt; obj = MyClass(att1=[0, 0, 0, 1])</span>
<span class="sd">    &gt;&gt;&gt; obj.att1</span>
<span class="sd">    &lt;Quat q1=0.00000000 q2=0.00000000 q3=0.00000000 q4=1.00000000&gt;</span>
<span class="sd">    &gt;&gt;&gt; obj.att2.equatorial</span>
<span class="sd">    array([10., 20., 30.])</span>
<span class="sd">    &gt;&gt;&gt; obj.att3 is None</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; obj.att3 = [10, 20, 30]</span>
<span class="sd">    &gt;&gt;&gt; obj.att3.equatorial</span>
<span class="sd">    array([10., 20., 30.])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot set both &#39;required&#39; and &#39;default&#39; arguments&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="n">required</span>

        <span class="c1"># Default is set here at the time of class creation, not at the time of</span>
        <span class="c1"># instantiation.  Coercing the default to the correct type is deferred until the</span>
        <span class="c1"># instance is created. This happens because at instance creation (if the</span>
        <span class="c1"># attribute value was not specified) the dataclass machinery evaluates</span>
        <span class="c1"># ``Class.attr`` (e.g. ``QuatDescriptor.quat``) which triggers the ``__get__``</span>
        <span class="c1"># method of the descriptor with ``obj=None``. That returns the default which is</span>
        <span class="c1"># then passed to the ``__set__`` method which does type coercion. See</span>
        <span class="c1"># https://docs.python.org/3/library/dataclasses.html#descriptor-typed-fields and</span>
        <span class="c1"># the bit about &quot;To determine whether a field contains a default value&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># See long comment above about why this is returning self.default.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span>

        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;attribute </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">!r}</span><span class="s2"> is required and cannot be set to None&quot;</span>
            <span class="p">)</span>
        <span class="c1"># None is the default value for the attribute if it is not set explicitly.</span>
        <span class="c1"># In this case it is not coerced to the descriptor type.</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2019, Javier Gonzalez.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
  </p>
</footer>
  </body>
</html>